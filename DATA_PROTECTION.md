# データ保護ガイド

## 概要

このアプリケーションは、コード更新（デプロイ）時にも既存のデータが消えないように設計されています。

## データ保護の仕組み

### 1. データディレクトリの保護

- `data/`ディレクトリは`.gitignore`で除外されており、Gitにコミットされません
- コード更新時にも`data/`ディレクトリは保持されます
- データディレクトリには`.data_protected`マーカーが作成され、保護状態が記録されます

### 2. 自動バックアップ

- アプリケーション起動時に、既存データがある場合は自動的にバックアップを作成します
- 24時間以内にバックアップが作成されていない場合のみ実行されます
- バックアップは`data/backups/`ディレクトリに保存されます

### 3. データマイグレーション

- スキーマバージョン管理により、データ形式が変更されても既存データを保持します
- マイグレーション前に自動的にバックアップを作成します
- マイグレーションエラーが発生しても既存データは保護されます

### 4. データ整合性チェック

- 起動時にデータファイルの整合性を確認します
- 破損が検出された場合、最新のバックアップから自動的に復元を試みます
- 復元に失敗した場合、元のファイルは`.corrupted`拡張子で保存されます

### 5. 初期化処理の保護

- すべての初期化処理は、ファイルが存在しない場合のみ実行されます
- 既存データは絶対に上書きされません

## デプロイ時の注意事項

### ✅ 安全なデプロイ手順

1. **データの確認**
   ```bash
   # データディレクトリの存在を確認
   ls -la data/
   ```

2. **手動バックアップ（推奨）**
   ```bash
   # 重要なデータの場合は、デプロイ前に手動でバックアップを作成
   cp -r data/ data_backup_$(date +%Y%m%d_%H%M%S)/
   ```

3. **コードの更新**
   ```bash
   git pull
   # または
   git checkout <branch>
   ```

4. **アプリケーションの再起動**
   - Streamlitアプリケーションを再起動すると、自動的にバックアップが作成されます
   - データ保護が有効になっていることを確認してください

### ⚠️ 注意事項

- **`data/`ディレクトリを削除しないでください**
  - ディレクトリを削除すると、すべてのデータが失われます
  - 削除した場合、バックアップから復元する必要があります

- **`.gitignore`の確認**
  - `data/`が`.gitignore`に含まれていることを確認してください
  - 含まれていない場合、Git操作でデータが失われる可能性があります

- **ディスク容量の確認**
  - バックアップは自動的に作成されるため、ディスク容量に注意してください
  - 古いバックアップは定期的に削除することを推奨します

## バックアップと復元

### バックアップの作成

アプリケーション内から手動でバックアップを作成できます：
- 設定画面から「データ管理」セクションを確認してください（将来の機能拡張予定）

### バックアップからの復元

1. `data/backups/`ディレクトリから復元したいバックアップを選択
2. バックアップディレクトリのパスをコピー
3. アプリケーション内の復元機能を使用（将来の機能拡張予定）

または、手動で復元：
```bash
# バックアップディレクトリを確認
ls -la data/backups/

# 必要なファイルを復元
cp data/backups/backup_YYYYMMDD_HHMMSS/users_master.json data/
cp data/backups/backup_YYYYMMDD_HHMMSS/daily_reports.csv data/
# ... その他のファイルも同様に
```

## トラブルシューティング

### データが表示されない

1. `data/`ディレクトリが存在するか確認
2. ファイルの読み取り権限を確認
3. データファイルが破損していないか確認（アプリケーションが自動的に検出します）

### バックアップが作成されない

1. `data/backups/`ディレクトリの書き込み権限を確認
2. ディスク容量を確認
3. アプリケーションのログを確認

### データが失われた

1. `data/backups/`ディレクトリから最新のバックアップを確認
2. バックアップから復元を試みる
3. それでも解決しない場合は、`.corrupted`拡張子のファイルを確認

## データファイルの場所

- 利用者マスタ: `data/users_master.json`
- 日報データ: `data/daily_reports.csv`
- タグマスタ: `data/tags_master.json`
- スタッフアカウント: `data/staff_accounts.json`
- 朝礼議事録: `data/morning_meetings.json`
- 設定ファイル: `data/config.json`
- 日報Markdownファイル: `data/reports/`
- バックアップ: `data/backups/`

## まとめ

このアプリケーションは、コード更新時にもデータが保護されるように設計されています。以下の点を守れば、データが失われることはありません：

1. ✅ `data/`ディレクトリを削除しない
2. ✅ `.gitignore`に`data/`が含まれていることを確認
3. ✅ 重要なデータは定期的に外部バックアップを作成
4. ✅ デプロイ前にデータの存在を確認

これらの仕組みにより、安心してコードを更新できます。
